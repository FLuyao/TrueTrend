import pandas as pd
import matplotlib.pyplot as plt
import os
import sys
import subprocess
from matplotlib import rcParams

# ========== ä¸­æ–‡å­—ä½“é…ç½® ==========
try:
    rcParams['font.sans-serif'] = ['Microsoft YaHei', 'SimHei', 'Arial Unicode MS', 'AppleGothic', 'WenQuanYi Zen Hei']
    rcParams['axes.unicode_minus'] = False
except:
    print("âš ï¸ ç³»ç»Ÿå¯èƒ½ç¼ºå°‘ä¸­æ–‡å­—ä½“ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤å­—ä½“")

# ========== æ–‡ä»¶è·¯å¾„é…ç½® ==========
desktop = os.path.join(os.path.expanduser('~'), 'Desktop')
save_path_qty = os.path.join(desktop, "çœŸç»´æ–¯å•†å“é”€å”®é‡ï¼ˆå…¨éƒ¨ï¼‰.png")
save_path_rev = os.path.join(desktop, "çœŸç»´æ–¯å•†å“é”€å”®æ€»é¢ï¼ˆå…¨éƒ¨ï¼‰.png")

# ========== æ•°æ®è¯»å–å‡½æ•° ==========
def safe_read(path):
    try:
        df = pd.read_excel(path, engine='openpyxl')
        print(f"âœ… æˆåŠŸè¯»å–: {path}")
        return df
    except Exception as e:
        print(f"âŒ è¯»å–å¤±è´¥: {path}\né”™è¯¯: {str(e)}")
        return None

# ========== è‡ªåŠ¨æŸ¥æ‰¾æ•°æ®æ–‡ä»¶ ==========
def find_data_files():
    possible_files = [
        ('çœŸç»´æ–¯_å•†å“é”€å”®ç»Ÿè®¡.xlsx', 'è¯„è®º_çœŸç»´æ–¯_æ¸…æ´—å.xlsx'),
        ('sales_data.xlsx', 'reviews_data.xlsx'),
        ('å•†å“é”€å”®.xlsx', 'å•†å“è¯„è®º.xlsx')
    ]
    
    search_dirs = [
        os.path.join(os.path.expanduser('~'), 'Desktop'),
        os.getcwd()
    ]
    
    for dir_path in search_dirs:
        for sales_name, reviews_name in possible_files:
            sales_path = os.path.join(dir_path, sales_name)
            reviews_path = os.path.join(dir_path, reviews_name)
            if os.path.exists(sales_path) and os.path.exists(reviews_path):
                return sales_path, reviews_path
    
    return None, None

# ========== ä¸»ç¨‹åº ==========
print("\nğŸ” æ­£åœ¨æŸ¥æ‰¾æ•°æ®æ–‡ä»¶...")
sales_path, reviews_path = find_data_files()

if not sales_path or not reviews_path:
    print("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶ï¼")
    print("è¯·ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨äºæ¡Œé¢æˆ–è„šæœ¬ç›®å½•ï¼š")
    print("1. é”€å”®æ•°æ®æ–‡ä»¶ï¼ˆå¦‚ï¼šçœŸç»´æ–¯_å•†å“é”€å”®ç»Ÿè®¡.xlsxï¼‰")
    print("2. è¯„è®ºæ•°æ®æ–‡ä»¶ï¼ˆå¦‚ï¼šè¯„è®º_çœŸç»´æ–¯_æ¸…æ´—å.xlsxï¼‰")
    sys.exit(1)

print(f"\nğŸ“ æ‰¾åˆ°æ–‡ä»¶ï¼š\n- é”€å”®æ•°æ®: {sales_path}\n- è¯„è®ºæ•°æ®: {reviews_path}")

# è¯»å–æ•°æ®
df_sales = safe_read(sales_path)
df_reviews = safe_read(reviews_path)

# æ£€æŸ¥å¿…è¦åˆ—
required_cols = {
    'sales': ['_itemnumber_', 'comment_count', 'estimated_price_by_sales'],
    'reviews': ['_itemnumber_']
}

for df_type, cols in required_cols.items():
    df = globals()[f'df_{df_type}']
    missing = [col for col in cols if col not in df.columns]
    if missing:
        print(f"âŒ é”™è¯¯ï¼š{df_type}è¡¨ç¼ºå°‘åˆ—: {missing}")
        print("ç°æœ‰åˆ—:", df.columns.tolist())
        sys.exit(1)

# è®¡ç®—é”€å”®æ€»é¢
print("\nğŸ”¢ æ­£åœ¨è®¡ç®—é”€å”®æ€»é¢...")
df_sales['total_sales'] = df_sales['estimated_price_by_sales'] * df_sales['comment_count']

# åˆå¹¶æ•°æ®å¹¶æŒ‰å•†å“ç¼–å·æ’åº
df_merged = pd.merge(
    df_sales[["_itemnumber_", "comment_count", "total_sales"]],
    df_reviews[["_itemnumber_"]].drop_duplicates(),
    on="_itemnumber_",
    how="inner"
).sort_values('_itemnumber_')  # æŒ‰å•†å“ç¼–å·æ’åº

# è·å–å…¨éƒ¨å•†å“æ•°æ®ï¼ˆä¸ç­›é€‰Top10ï¼‰
all_by_quantity = df_merged.groupby("_itemnumber_")["comment_count"].sum()
all_by_revenue = df_merged.groupby("_itemnumber_")["total_sales"].sum()

# =============================================
# å›¾1ï¼šé”€å”®é‡åˆ†æï¼ˆå…¨éƒ¨å•†å“ï¼‰
# =============================================
plt.figure(figsize=(16, 8))
bars_qty = plt.bar(
    all_by_quantity.index.astype(str), 
    all_by_quantity.values, 
    color='#4B96E9',
    width=0.8
)

# ä¼˜åŒ–æ˜¾ç¤ºï¼šæ¯éš”Nä¸ªå•†å“æ˜¾ç¤ºä¸€ä¸ªæ ‡ç­¾
step = max(1, len(all_by_quantity) // 20)  # è‡ªåŠ¨è®¡ç®—æ ‡ç­¾é—´éš”
plt.xticks(range(0, len(all_by_quantity), step), 
           all_by_quantity.index.astype(str)[::step],
           rotation=45, ha='right')

plt.title("çœŸç»´æ–¯å•†å“é”€å”®é‡ï¼ˆå…¨éƒ¨å•†å“ï¼‰", fontsize=16, pad=20)
plt.xlabel("å•†å“ç¼–å·", fontsize=12)
plt.ylabel("é”€å”®æ•°é‡", fontsize=12)
plt.grid(axis='y', alpha=0.3)

# æ·»åŠ å¹³å‡å€¼å‚è€ƒçº¿
mean_qty = all_by_quantity.mean()
plt.axhline(mean_qty, color='red', linestyle='--', linewidth=1)
plt.text(len(all_by_quantity)*0.98, mean_qty*1.05, 
         f'å¹³å‡é”€é‡: {mean_qty:,.0f}', 
         ha='right', va='bottom', color='red')

plt.tight_layout()

# ä¿å­˜é”€å”®é‡å›¾ç‰‡
print(f"\nğŸ’¾ æ­£åœ¨ä¿å­˜é”€å”®é‡å›¾ç‰‡åˆ°: {save_path_qty}")
plt.savefig(save_path_qty, dpi=150, bbox_inches='tight')
plt.close()

# =============================================
# å›¾2ï¼šé”€å”®æ€»é¢åˆ†æï¼ˆå…¨éƒ¨å•†å“ï¼‰
# =============================================
plt.figure(figsize=(16, 8))
bars_rev = plt.bar(
    all_by_revenue.index.astype(str), 
    all_by_revenue.values, 
    color='#FF6B6B',
    width=0.8
)

# ä¼˜åŒ–æ˜¾ç¤ºï¼šæ¯éš”Nä¸ªå•†å“æ˜¾ç¤ºä¸€ä¸ªæ ‡ç­¾
step = max(1, len(all_by_revenue) // 20)  # è‡ªåŠ¨è®¡ç®—æ ‡ç­¾é—´éš”
plt.xticks(range(0, len(all_by_revenue), step), 
           all_by_revenue.index.astype(str)[::step],
           rotation=45, ha='right')

plt.title("çœŸç»´æ–¯å•†å“é”€å”®æ€»é¢ï¼ˆå…¨éƒ¨å•†å“ï¼‰", fontsize=16, pad=20)
plt.xlabel("å•†å“ç¼–å·", fontsize=12)
plt.ylabel("é”€å”®æ€»é¢", fontsize=12)
plt.grid(axis='y', alpha=0.3)

# æ·»åŠ å¹³å‡å€¼å‚è€ƒçº¿å’Œï¿¥æ ‡ç­¾
mean_rev = all_by_revenue.mean()
plt.axhline(mean_rev, color='blue', linestyle='--', linewidth=1)
plt.text(len(all_by_revenue)*0.98, mean_rev*1.05, 
         f'å¹³å‡é”€å”®é¢: ï¿¥{mean_rev:,.0f}', 
         ha='right', va='bottom', color='blue')

# æ·»åŠ ç²¾é€‰çš„ï¿¥æ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºå‰5å’Œå5ä¸ªå•†å“ï¼‰
for i, (item, value) in enumerate(all_by_revenue.items()):
    if i < 5 or i >= len(all_by_revenue)-5:  # åªæ ‡æ³¨é¦–å°¾å„5ä¸ªå•†å“
        plt.text(i, value + max(all_by_revenue)*0.01, 
                 f"ï¿¥{value:,.0f}", 
                 rotation=90, ha='center', va='bottom',
                 fontsize=8)

plt.tight_layout()

# ä¿å­˜é”€å”®æ€»é¢å›¾ç‰‡
print(f"ğŸ’¾ æ­£åœ¨ä¿å­˜é”€å”®æ€»é¢å›¾ç‰‡åˆ°: {save_path_rev}")
plt.savefig(save_path_rev, dpi=150, bbox_inches='tight')
plt.close()

# ========== å°è¯•æ‰“å¼€å›¾ç‰‡ ==========
def try_open_image(path):
    print(f"\nğŸ”„ å°è¯•æ‰“å¼€å›¾ç‰‡: {path}")
    try:
        if sys.platform == 'win32':
            os.startfile(path)
        elif sys.platform == 'darwin':
            subprocess.run(['open', path])
        else:
            subprocess.run(['xdg-open', path])
        print("âœ… å›¾ç‰‡å·²æˆåŠŸæ‰“å¼€ï¼")
    except Exception as e:
        print(f"âš ï¸ è‡ªåŠ¨æ‰“å¼€å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¿é—®")
        print(f"é”™è¯¯è¯¦æƒ…: {str(e)}")

try_open_image(save_path_qty)
try_open_image(save_path_rev)

# æœ€ç»ˆéªŒè¯
print("\nâœ”ï¸ éªŒè¯ç”Ÿæˆç»“æœ:")
print(f"- é”€å”®é‡å›¾è¡¨: {save_path_qty} ({os.path.getsize(save_path_qty)/1024:.1f} KB)")
print(f"- é”€å”®é¢å›¾è¡¨: {save_path_rev} ({os.path.getsize(save_path_rev)/1024:.1f} KB)")
print(f"- åˆ†æå•†å“æ€»æ•°: {len(all_by_quantity)}ä¸ª")
